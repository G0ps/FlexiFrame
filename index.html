<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WebSocket Dynamic UI</title>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
    }
    #input-box {
        width: 100%;
        height: 50px;
    }
    #send-btn {
        margin-top: 10px;
    }
    .message-block {
        background: #eee;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
    }
</style>
</head>
<body>

<h2>Test WebSocket</h2>

<textarea id="input-box" placeholder="Type your prompt..."></textarea>
<button id="send-btn">Send</button>

<h3>Responses:</h3>
<div id="messages"></div>

<!-- Dynamic UI mount point -->
<div id="dynamic-ui-container"></div>

<script>

// ----------- DYNAMIC UI GENERATOR -------------
function append_UI(input_k, func_k) {
    try {
        const newFunction = new Function("input_k", func_k);

        console.log("Data look:", input_k);

        let root = document.getElementById("dynamic-ui-container");
        if (!root) {
            root = document.createElement("div");
            root.id = "dynamic-ui-container";
            document.body.appendChild(root);
        }

        root.innerHTML = ""; // clear previous dynamic UI

        newFunction(input_k); // execute generated function

        console.log("Executed UI function");
    } catch (err) {
        console.error("UI generation failed:", err);
    }
}

// ----------- MAIN APP LOGIC -------------
let ws;

function setupWebSocket() {
    ws = new WebSocket("ws://localhost:2000/ws/chat");

    ws.onopen = () => console.log("Connected");

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);

            let responseObj;
            try {
                responseObj = 
                    typeof data.response === "string"
                        ? JSON.parse(data.response)
                        : data.response;
            } catch (err) {
                console.error("Failed to parse response JSON:", err);
                responseObj = data.response;
            }

            const input_data = JSON.parse(data.input);

            console.log("Received Response:", responseObj);
            console.log("Input:", input_data);

            // DYNAMIC UI CALL
            append_UI(input_data, responseObj.output);

            appendMessage(JSON.stringify({ ...data, response: responseObj }, null, 2));

        } catch (err) {
            console.error("Invalid JSON received:", err);
        }
    };

    ws.onerror = (err) => console.error("WS error:", err);
    ws.onclose = () => console.log("WS closed");
}

function appendMessage(text) {
    const msgBlock = document.createElement("pre");
    msgBlock.className = "message-block";
    msgBlock.textContent = text;
    document.getElementById("messages").appendChild(msgBlock);
}


function sendMessage() {
    const input = document.getElementById("input-box").value.trim();
    if (!input) return;

    ws.send(input);
    document.getElementById("input-box").value = "";
}


document.getElementById("send-btn").addEventListener("click", sendMessage);

document.getElementById("input-box").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
    }
});


// ---------- INIT ----------
setupWebSocket();

</script>
</body>
</html>
